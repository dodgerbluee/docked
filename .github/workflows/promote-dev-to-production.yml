name: Promote Dev to Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "promote" to confirm promoting dev to production'
        required: true
        type: string
      version_override:
        description: 'Override version (leave empty to use latest dev version)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  NODE_VERSION: '18'

jobs:
  # Job 1: Prepare promotion (get version, validate, update package.json)
  prepare-promotion:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'promote'
    permissions:
      contents: read
    outputs:
      tag_name: ${{ steps.version.outputs.tag_name }}
      release_version: ${{ steps.version.outputs.release_version }}
      commits: ${{ steps.commits.outputs.commits }}
      previous_tag: ${{ steps.commits.outputs.previous_tag }}
    steps:
      - name: Check repository permissions
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const actor = context.actor;
            const isOwner = repo.owner.login.toLowerCase() === actor.toLowerCase();
            
            let hasAdmin = false;
            try {
              const { data: permissions } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: actor
              });
              hasAdmin = permissions.permission === 'admin';
            } catch (error) {
              hasAdmin = false;
            }
            
            if (!isOwner && !hasAdmin) {
              core.setFailed('Only repository owners and admins can promote to production.');
            }
            
            core.info(`User ${actor} is ${isOwner ? 'owner' : hasAdmin ? 'admin' : 'not authorized'}`);

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            server/package-lock.json
            client/package-lock.json

      - name: Install dependencies
        run: |
          npm ci
          cd server && npm ci
          cd ../client && npm ci

      - name: Get version from dev or override
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version_override }}" ]; then
            RELEASE_VERSION="${{ github.event.inputs.version_override }}"
            echo "Using provided version: $RELEASE_VERSION"
          else
            git fetch --tags --force
            LATEST_DEV_TAG=$(git tag -l "*-dev" | sort -V | tail -1)
            
            if [ -z "$LATEST_DEV_TAG" ]; then
              echo "‚ùå Error: No dev tag found. Please ensure a dev pre-release has been created first."
              exit 1
            fi
            
            RELEASE_VERSION=$(echo "$LATEST_DEV_TAG" | sed 's/^v\(.*\)-dev$/\1/')
            echo "Latest dev tag: $LATEST_DEV_TAG"
            echo "Promoting to version: $RELEASE_VERSION"
          fi
          
          if ! echo "$RELEASE_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "‚ùå Error: Invalid version format: $RELEASE_VERSION"
            echo "Version must be in format X.Y.Z (e.g., 1.2.3)"
            exit 1
          fi
          
          TAG_NAME="v${RELEASE_VERSION}"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
          echo "Final production version: $RELEASE_VERSION (tag: $TAG_NAME)"

      - name: Check if version already exists
        run: |
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ùå Error: Tag $TAG_NAME already exists. Please use a different version or delete the existing tag."
            exit 1
          fi
          echo "‚úì Version $TAG_NAME is available"

      - name: Get commits since previous release
        id: commits
        run: |
          PREVIOUS_RELEASE_TAG=$(git tag -l "v*" | grep -v "dev" | grep -v "latest" | sort -V | tail -1)
          
          if [ -n "$PREVIOUS_RELEASE_TAG" ]; then
            BASE_TAG="$PREVIOUS_RELEASE_TAG"
            echo "Using previous release tag: $BASE_TAG"
            echo "previous_tag=$PREVIOUS_RELEASE_TAG" >> $GITHUB_OUTPUT
          else
            BASE_TAG=""
            echo "No previous release tags found, using all commits"
          fi
          
          if [ -z "$BASE_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s|%h|%H" --reverse | (grep -E "^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\([^)]+\))?:" || true) | head -50)
          else
            COMMITS=$(git log ${BASE_TAG}..HEAD --pretty=format:"%s|%h|%H" --reverse | (grep -E "^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\([^)]+\))?:" || true))
          fi
          
          if [ -z "$COMMITS" ]; then
            COMMITS_LIST="- No conventional commits since previous release"
          else
            COMMITS_LIST=$(echo "$COMMITS" | while IFS='|' read -r subject hash fullhash; do
              echo "- $subject ([${hash:0:7}](https://github.com/${{ github.repository }}/commit/$fullhash))"
            done)
          fi
          
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # Job 2: Run tests and security scans
  test-and-security:
    runs-on: ubuntu-latest
    needs: prepare-promotion
    if: github.event.inputs.confirm == 'promote'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            server/package-lock.json
            client/package-lock.json

      - name: Install dependencies
        run: |
          npm ci
          cd server && npm ci
          cd ../client && npm ci

      - name: Run tests
        run: |
          cd server
          npm test -- --coverage --watchAll=false
          cd ../client
          CI=true npm test -- --coverage --watchAll=false

      - name: Run security scans
        run: |
          npm audit --audit-level=moderate
          cd server && npm audit --audit-level=moderate
          cd ../client && npm audit --audit-level=moderate

  # Job 3: Build application and create artifacts
  build:
    runs-on: ubuntu-latest
    needs: [prepare-promotion, test-and-security]
    if: github.event.inputs.confirm == 'promote'
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            server/package-lock.json
            client/package-lock.json

      - name: Install dependencies
        run: |
          npm ci
          cd server && npm ci
          cd ../client && npm ci

      - name: Update version in package.json files
        run: |
          RELEASE_VERSION="${{ needs.prepare-promotion.outputs.release_version }}"
          echo "Updating version to $RELEASE_VERSION in all package.json files"
          npm pkg set version="$RELEASE_VERSION"
          cd server && npm pkg set version="$RELEASE_VERSION"
          cd ../client && npm pkg set version="$RELEASE_VERSION"
          cd ..

      - name: Build client
        run: |
          cd client
          npm run build

      - name: Create release artifacts
        run: |
          mkdir -p release-artifacts
          tar -czf release-artifacts/docked-${{ needs.prepare-promotion.outputs.release_version }}-source.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='data' \
            --exclude='.github' \
            --exclude='release-artifacts' \
            .
          cd release-artifacts
          sha256sum docked-${{ needs.prepare-promotion.outputs.release_version }}-source.tar.gz > docked-${{ needs.prepare-promotion.outputs.release_version }}-source.tar.gz.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-artifacts
          path: release-artifacts/
          retention-days: 90

  # Job 4: Extract Docker metadata (shared by both build jobs)
  docker-metadata:
    runs-on: ubuntu-latest
    needs: [prepare-promotion, build]
    if: github.event.inputs.confirm == 'promote'
    outputs:
      tags: ${{ steps.meta.outputs.tags }}
      labels: ${{ steps.meta.outputs.labels }}
    steps:
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}
          tags: |
            type=raw,value=${{ needs.prepare-promotion.outputs.release_version }}
            type=raw,value=latest
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
          flavor: |
            latest=true

  # Job 5: Build and push Docker image for amd64 (runs in parallel with arm64)
  docker-amd64:
    runs-on: ubuntu-latest
    needs: [prepare-promotion, build, docker-metadata]
    if: github.event.inputs.confirm == 'promote'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Update version in package.json files
        run: |
          RELEASE_VERSION="${{ needs.prepare-promotion.outputs.release_version }}"
          echo "Updating version to $RELEASE_VERSION in all package.json files for Docker build"
          git fetch origin
          npm pkg set version="$RELEASE_VERSION"
          cd server && npm pkg set version="$RELEASE_VERSION"
          cd ../client && npm pkg set version="$RELEASE_VERSION"
          cd ..

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image (amd64)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}:${{ needs.prepare-promotion.outputs.release_version }}-amd64
            ${{ env.REGISTRY }}/${{ github.repository }}:latest-amd64
          labels: ${{ needs.docker-metadata.outputs.labels }}
          build-args: |
            NODE_ENV=production
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # Job 6: Build and push Docker image for arm64 (runs in parallel with amd64)
  docker-arm64:
    runs-on: ubuntu-latest
    needs: [prepare-promotion, build, docker-metadata]
    if: github.event.inputs.confirm == 'promote'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Update version in package.json files
        run: |
          RELEASE_VERSION="${{ needs.prepare-promotion.outputs.release_version }}"
          echo "Updating version to $RELEASE_VERSION in all package.json files for Docker build"
          git fetch origin
          npm pkg set version="$RELEASE_VERSION"
          cd server && npm pkg set version="$RELEASE_VERSION"
          cd ../client && npm pkg set version="$RELEASE_VERSION"
          cd ..

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image (arm64)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}:${{ needs.prepare-promotion.outputs.release_version }}-arm64
            ${{ env.REGISTRY }}/${{ github.repository }}:latest-arm64
          labels: ${{ needs.docker-metadata.outputs.labels }}
          build-args: |
            NODE_ENV=production
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/arm64

  # Job 7: Create multi-arch manifest from separate architecture builds
  docker-manifest:
    runs-on: ubuntu-latest
    needs: [prepare-promotion, docker-amd64, docker-arm64]
    if: github.event.inputs.confirm == 'promote'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create multi-arch manifest for version tag
        run: |
          RELEASE_VERSION="${{ needs.prepare-promotion.outputs.release_version }}"
          IMAGE="${{ env.REGISTRY }}/${{ github.repository }}"
          
          # Create multi-arch manifest from amd64 and arm64 images
          docker buildx imagetools create \
            --tag ${IMAGE}:${RELEASE_VERSION} \
            ${IMAGE}:${RELEASE_VERSION}-amd64 \
            ${IMAGE}:${RELEASE_VERSION}-arm64
          
          echo "‚úì Created multi-arch manifest for ${IMAGE}:${RELEASE_VERSION}"

      - name: Create multi-arch manifest for latest tag
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository }}"
          
          # Create multi-arch manifest from amd64 and arm64 images
          docker buildx imagetools create \
            --tag ${IMAGE}:latest \
            ${IMAGE}:latest-amd64 \
            ${IMAGE}:latest-arm64
          
          echo "‚úì Created multi-arch manifest for ${IMAGE}:latest"

      - name: Create multi-arch manifest for semver tags
        run: |
          RELEASE_VERSION="${{ needs.prepare-promotion.outputs.release_version }}"
          IMAGE="${{ env.REGISTRY }}/${{ github.repository }}"
          
          # Extract major and minor version numbers
          MAJOR=$(echo "$RELEASE_VERSION" | cut -d. -f1)
          MINOR=$(echo "$RELEASE_VERSION" | cut -d. -f2)
          
          # Create multi-arch manifest for major.minor tag
          docker buildx imagetools create \
            --tag ${IMAGE}:${MAJOR}.${MINOR} \
            ${IMAGE}:${RELEASE_VERSION}-amd64 \
            ${IMAGE}:${RELEASE_VERSION}-arm64
          
          # Create multi-arch manifest for major tag
          docker buildx imagetools create \
            --tag ${IMAGE}:${MAJOR} \
            ${IMAGE}:${RELEASE_VERSION}-amd64 \
            ${IMAGE}:${RELEASE_VERSION}-arm64
          
          echo "‚úì Created multi-arch manifests for semver tags"

  # Job 8: Create release and finalize promotion
  create-release:
    runs-on: ubuntu-latest
    needs: [prepare-promotion, build, docker-manifest]
    if: github.event.inputs.confirm == 'promote'
    permissions:
      contents: write
      packages: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          npm ci
          cd server && npm ci
          cd ../client && npm ci

      - name: Update version in package.json files
        run: |
          RELEASE_VERSION="${{ needs.prepare-promotion.outputs.release_version }}"
          npm pkg set version="$RELEASE_VERSION"
          cd server && npm pkg set version="$RELEASE_VERSION"
          cd ../client && npm pkg set version="$RELEASE_VERSION"
          cd ..

      - name: Generate changelog
        id: changelog
        uses: metcalfc/changelog-generator@v4
        with:
          myToken: ${{ secrets.GITHUB_TOKEN }}
          configurationPath: .github/changelog-config.json

      - name: Commit version update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet package.json server/package.json client/package.json; then
            echo "No version changes to commit"
          else
            git add package.json server/package.json client/package.json
            git commit -m "chore: promote dev to production v${{ needs.prepare-promotion.outputs.release_version }} [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
            echo "‚úì Committed version update to ${{ needs.prepare-promotion.outputs.release_version }}"
          fi

      - name: Create git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.prepare-promotion.outputs.tag_name }}" -m "Release v${{ needs.prepare-promotion.outputs.release_version }}"
          git push origin "${{ needs.prepare-promotion.outputs.tag_name }}"
          echo "‚úì Created and pushed tag ${{ needs.prepare-promotion.outputs.tag_name }}"

      - name: Download artifacts
        uses: actions/download-artifact@v6
        with:
          name: release-artifacts
          path: release-artifacts/

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ needs.prepare-promotion.outputs.tag_name }}"
          RELEASE_VERSION="${{ needs.prepare-promotion.outputs.release_version }}"
          RELEASE_NAME="v$RELEASE_VERSION"
          RELEASE_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          if [ -n "${{ needs.prepare-promotion.outputs.previous_tag }}" ]; then
            PREV_TAG="${{ needs.prepare-promotion.outputs.previous_tag }}"
            CHANGELOG_LINK="[${PREV_TAG}...${TAG_NAME}](https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${TAG_NAME})"
          else
            CHANGELOG_LINK="[${TAG_NAME}](https://github.com/${{ github.repository }}/commits/${TAG_NAME})"
          fi
          
          RELEASE_BODY=$(cat <<EOF
          ## üöÄ Release v$RELEASE_VERSION
          
          **Release Date:** $RELEASE_DATE  
          **Promoted by:** @${{ github.actor }}  
          **Promoted from:** Latest dev build
          
          ${{ steps.changelog.outputs.changelog }}
          
          ## üì¶ Downloads
          
          ### Source Code
          - **Source Tarball:** [docked-$RELEASE_VERSION-source.tar.gz](https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/docked-$RELEASE_VERSION-source.tar.gz)
          - **SHA256 Checksum:** [docked-$RELEASE_VERSION-source.tar.gz.sha256](https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/docked-$RELEASE_VERSION-source.tar.gz.sha256)
          
          ### Container Image
          \`\`\`bash
          docker pull ${{ env.REGISTRY }}/${{ github.repository }}:$RELEASE_VERSION
          docker pull ${{ env.REGISTRY }}/${{ github.repository }}:latest
          \`\`\`
          
          ## üìù Commits in This Release
          
          ${{ needs.prepare-promotion.outputs.commits }}
          
          ---
          
          $CHANGELOG_LINK
          
          ## üîÑ Upgrade Instructions
          
          See [UPGRADE.md](https://github.com/${{ github.repository }}/blob/main/UPGRADE.md) for detailed upgrade instructions.
          EOF
          )
          
          gh release create "$TAG_NAME" \
            --title "$RELEASE_NAME" \
            --notes "$RELEASE_BODY" \
            --repo ${{ github.repository }}

      - name: Attach artifacts to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ needs.prepare-promotion.outputs.tag_name }}"
          RELEASE_VERSION="${{ needs.prepare-promotion.outputs.release_version }}"
          
          if [ -f "release-artifacts/docked-$RELEASE_VERSION-source.tar.gz" ]; then
            gh release upload "$TAG_NAME" \
              release-artifacts/docked-$RELEASE_VERSION-source.tar.gz \
              release-artifacts/docked-$RELEASE_VERSION-source.tar.gz.sha256 \
              --repo ${{ github.repository }} || echo "Artifacts may already be attached"
          fi

      - name: Promotion summary
        run: |
          echo "## ‚úÖ Promotion Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully promoted **dev** to **production**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.prepare-promotion.outputs.release_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Images:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ github.repository }}:${{ needs.prepare-promotion.outputs.release_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ github.repository }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**GitHub Release:** [v${{ needs.prepare-promotion.outputs.release_version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.prepare-promotion.outputs.release_version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Promoted by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Promoted at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  validation:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm != 'promote'
    steps:
      - name: Validation failed
        run: |
          echo "‚ùå Promotion cancelled. You must type 'promote' in the confirmation field."
          exit 1
