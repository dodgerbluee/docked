name: Run Linting (Reusable)

on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version"
        required: true
        type: string
      check-formatting:
        description: "Check code formatting"
        required: false
        type: boolean
        default: false

jobs:
  eslint-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            server/package-lock.json

      - name: Install dependencies
        run: |
          npm ci
          cd server && npm ci

      # ESLint server step disabled â€” server eslint config needs cleanup first
      # - name: Run ESLint (server)
      #   run: |
      #     cd server
      #     if [ -f "node_modules/.bin/eslint" ]; then
      #       npx eslint . --ext .js
      #     else
      #       echo "ESLint not found in server/node_modules/.bin/eslint"
      #       exit 1
      #     fi

  eslint-client:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            client/package-lock.json

      - name: Install dependencies
        run: |
          npm ci
          cd client && npm ci

      - name: Run ESLint (client)
        run: |
          cd client
          if [ -f "node_modules/.bin/eslint" ]; then
            npx eslint src --max-warnings=0
          elif [ -d "node_modules/react-scripts" ]; then
            DISABLE_ESLINT_PLUGIN=true CI=true npm run build 2>&1 | tee /tmp/build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
            if [ $BUILD_EXIT_CODE -ne 0 ]; then
              if grep -qiE "(eslint|Failed to compile)" /tmp/build.log; then
                grep -iE "(eslint|error|warning|Failed)" /tmp/build.log | head -50
                exit 1
              fi
              exit $BUILD_EXIT_CODE
            fi
            # CI=true should make react-scripts fail on warnings, but check explicitly for ESLint warnings
            if grep -qiE "(eslint.*warning|warning.*eslint)" /tmp/build.log; then
              echo "Build contains ESLint warnings. Failing lint check."
              grep -iE "(eslint.*warning|warning.*eslint)" /tmp/build.log | head -50
              exit 1
            fi
          else
            npm install --save-dev eslint
            npx eslint src --ext .js,.jsx --max-warnings=0
          fi

  prettier:
    runs-on: ubuntu-latest
    if: inputs.check-formatting == true
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"
          cache-dependency-path: |
            package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Check formatting (Prettier)
        run: |
          if [ -f "node_modules/.bin/prettier" ]; then
            npx prettier --check "**/*.{js,jsx,json,css,md}" || (echo "Formatting check failed. Run 'prettier --write' to fix." && exit 1)
          else
            echo "Prettier not installed, skipping formatting check"
            exit 1
          fi
