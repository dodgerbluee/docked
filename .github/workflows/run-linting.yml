name: Run Linting (Reusable)

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version'
        required: true
        type: string
      check-formatting:
        description: 'Check code formatting'
        required: false
        type: boolean
        default: false

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            server/package-lock.json
            client/package-lock.json

      - name: Install dependencies
        run: |
          npm ci
          cd server && npm ci
          cd ../client && npm ci

      # - name: Run ESLint (server)
      #   run: |
      #     cd server
      #     if [ -f "node_modules/.bin/eslint" ]; then
      #       npx eslint . --ext .js
      #     else
      #       npm install --save-dev eslint@^8.57.0
      #       npx eslint . --ext .js
      #     fi

      - name: Run ESLint (client)
        run: |
          cd client
          if [ -f "node_modules/.bin/eslint" ]; then
            npx eslint src --ext .js,.jsx
          elif [ -d "node_modules/react-scripts" ]; then
            CI=true npm run build 2>&1 | tee /tmp/build.log
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
            if [ $BUILD_EXIT_CODE -ne 0 ]; then
              if grep -qiE "(eslint|Failed to compile)" /tmp/build.log; then
                grep -iE "(eslint|error|warning|Failed)" /tmp/build.log | head -50
                exit 1
              fi
              exit $BUILD_EXIT_CODE
            fi
          else
            npm install --save-dev eslint
            npx eslint src --ext .js,.jsx
          fi

      - name: Check formatting (Prettier)
        if: inputs.check-formatting == true
        run: |
          if [ -f "node_modules/.bin/prettier" ]; then
            npx prettier --check "**/*.{js,jsx,json,css,md}" || (echo "Formatting check failed. Run 'prettier --write' to fix." && exit 1)
          else
            echo "Prettier not installed, skipping formatting check"
          fi

