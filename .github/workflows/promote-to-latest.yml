name: Promote Dev to Latest

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "promote" to confirm promoting dev to latest'
        required: true
        type: string
      create_release:
        description: 'Create a GitHub release for this promotion'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io

jobs:
  promote:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'promote'
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        if: github.event.inputs.create_release == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if dev image exists
        run: |
          if ! docker manifest inspect ${{ env.REGISTRY }}/${{ github.repository }}:dev > /dev/null 2>&1; then
            echo "‚ùå Error: dev image not found at ${{ env.REGISTRY }}/${{ github.repository }}:dev"
            echo "Please ensure a dev image has been built first."
            exit 1
          fi
          echo "‚úì Found dev image"

      - name: Tag dev as latest
        run: |
          # Pull the dev image (this will work for multi-arch images)
          docker pull ${{ env.REGISTRY }}/${{ github.repository }}:dev
          
          # Tag it as latest
          docker tag ${{ env.REGISTRY }}/${{ github.repository }}:dev ${{ env.REGISTRY }}/${{ github.repository }}:latest
          
          # Push the latest tag
          docker push ${{ env.REGISTRY }}/${{ github.repository }}:latest
          
          echo "‚úì Successfully promoted dev to latest"

      - name: Install dependencies
        if: github.event.inputs.create_release == 'true'
        run: npm install

      - name: Get current version and determine release tag
        id: version
        if: github.event.inputs.create_release == 'true'
        run: |
          # Get current version from package.json
          BASE_VERSION=$(node -p "require('./package.json').version")
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          
          # Fetch all tags to find the latest -latest tag
          git fetch --tags --force
          
          # Find all existing -latest tags and extract their base versions
          LATEST_TAG=$(git tag -l "*-latest" | sort -V | tail -1)
          
          if [ -z "$LATEST_TAG" ]; then
            # No existing -latest tag, use current version
            TAG_NAME="v${BASE_VERSION}-latest"
            RELEASE_VERSION="$BASE_VERSION"
            echo "No existing -latest tag found, using base version: $BASE_VERSION"
          else
            # Extract version from latest tag (e.g., v1.0.0-latest -> 1.0.0)
            LATEST_VERSION=$(echo "$LATEST_TAG" | sed 's/v\(.*\)-latest/\1/')
            echo "Latest -latest tag: $LATEST_TAG (version: $LATEST_VERSION)"
            
            # Use semver to compare and increment versions
            RELEASE_VERSION=$(node -e "
              const semver = require('semver');
              const baseVersion = '$BASE_VERSION';
              const latestVersion = '$LATEST_VERSION';
              
              // Compare versions - if current version is newer, use it; otherwise increment patch
              if (semver.gt(baseVersion, latestVersion)) {
                console.log(baseVersion);
              } else {
                // Increment patch version from latest tag
                console.log(semver.inc(latestVersion, 'patch'));
              }
            ")
            
            # Determine which version was used for logging
            if [ "$RELEASE_VERSION" = "$BASE_VERSION" ]; then
              echo "Current version ($BASE_VERSION) is newer than latest tag ($LATEST_VERSION), using current version"
            else
              echo "Incrementing patch version: $LATEST_VERSION -> $RELEASE_VERSION"
            fi
            
            TAG_NAME="v${RELEASE_VERSION}-latest"
          fi
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
          echo "Final tag: $TAG_NAME (version: $RELEASE_VERSION)"

      - name: Get commits since previous release
        id: commits
        if: github.event.inputs.create_release == 'true'
        run: |
          # Find the previous -latest tag or the latest regular release tag
          PREVIOUS_LATEST_TAG=$(git tag -l "*-latest" | sort -V | tail -1)
          PREVIOUS_RELEASE_TAG=$(git tag -l "v*" | grep -v "latest" | sort -V | tail -1)
          
          # Determine which tag to use as the base
          if [ -n "$PREVIOUS_LATEST_TAG" ]; then
            # Use the previous -latest tag if it exists
            BASE_TAG="$PREVIOUS_LATEST_TAG"
            echo "Using previous -latest tag: $BASE_TAG"
          elif [ -n "$PREVIOUS_RELEASE_TAG" ]; then
            # Otherwise use the latest regular release tag
            BASE_TAG="$PREVIOUS_RELEASE_TAG"
            echo "Using previous release tag: $BASE_TAG"
          else
            # No previous tags, use the initial commit
            BASE_TAG=""
            echo "No previous tags found, using all commits"
          fi
          
          # Get commits between BASE_TAG and HEAD
          if [ -z "$BASE_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --reverse)
          else
            COMMITS=$(git log ${BASE_TAG}..HEAD --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --reverse)
          fi
          
          if [ -z "$COMMITS" ]; then
            COMMITS="- No new commits since previous release"
          fi
          
          # Store in output (escape newlines for GitHub Actions)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: github.event.inputs.create_release == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          RELEASE_VERSION="${{ steps.version.outputs.release_version }}"
          RELEASE_NAME="v$RELEASE_VERSION"
          RELEASE_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          RELEASE_BODY=$(cat <<EOF
          This release marks the promotion of the **dev** image to **latest** after testing.
          
          **Docker Image:** \`${{ env.REGISTRY }}/${{ github.repository }}:latest\`
          
          **Promoted by:** @${{ github.actor }}
          **Promoted at:** $RELEASE_DATE
          
          This image has been tested and verified as stable.
          
          ---
          
          ## üìù Commits in This Release
          
          ${{ steps.commits.outputs.commits }}
          EOF
          )
          
          gh release create "$TAG_NAME" \
            --title "$RELEASE_NAME" \
            --notes "$RELEASE_BODY" \
            --repo ${{ github.repository }}
          
          echo "‚úì Created GitHub release: $TAG_NAME"

      - name: Get image info
        run: |
          echo "## Promotion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Successfully promoted **dev** to **latest**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.REGISTRY }}/${{ github.repository }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.create_release }}" == "true" ]; then
            echo "**GitHub Release:** Created [${{ steps.version.outputs.tag_name }}](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag_name }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Promoted by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Promoted at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  validation:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm != 'promote'
    steps:
      - name: Validation failed
        run: |
          echo "‚ùå Promotion cancelled. You must type 'promote' in the confirmation field."
          exit 1

